<template>
    <el-dialog :visible="visible"
               @close="close"
               top="5vh"
               custom-class="create-sales-volume"
               :title="exploitRecord.recordId ? '修改开发记录' : '新增开发记录'"
               :close-on-click-modal="false"
               width="600px">
        <el-form :model="record" label-width="110px">
          <el-form-item label="药品" required>
            <el-select size="small" v-model="record.medicineId" filterable @change="medicineChange">
              <el-option v-for="item in medicines" :key="item.medicineId" :label="item.medicineName" :value="item.medicineId"></el-option>
            </el-select>
          </el-form-item>
          <el-row>
            <el-col :span="24">
              <el-form-item label="区域" required>
                <el-select size="small" placeholder="请选择"
                           clearable
                           filterable
                           style="width: 140px"
                           @change="loadCities"
                           v-model="record.provinceAreaCode">
                  <el-option v-for="item in provinces" :key="item.id" :label="item.areaName" :value="item.areaCode"></el-option>
                </el-select>
                <el-select size="small" placeholder="请选择"
                           clearable
                           filterable
                           style="width: 140px"
                           @change="loadRegions"
                           v-model="record.cityAreaCode">
                  <el-option v-for="item in cities" :key="item.id" :label="item.areaName" :value="item.areaCode"></el-option>
                </el-select>
                <el-select size="small" placeholder="请选择"
                           clearable
                           filterable
                           style="width: 140px"
                           @change="loadHospitals"
                           v-model="record.regionAreaCode">
                  <el-option v-for="item in regions" :key="item.id" :label="item.areaName" :value="item.areaCode"></el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="医院" required>
            <el-select size="small" v-model="record.hospitalId" filterable>
              <el-option v-for="item in hospitals" :key="item.hospitalId" :label="item.hospitalName" :value="item.hospitalId"></el-option>
            </el-select>
          </el-form-item>
            <el-form-item label="部门" required>
                <el-select size="small" v-model="record.departmentId" filterable>
                    <el-option v-for="item in departments" :key="item.departmentId" :label="item.departmentName" :value="item.departmentId"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="是否院内" required>
                <el-select size="small" v-model="record.isOut">
                    <el-option label="院内" :value="false"></el-option>
                    <el-option label="院外" :value="true"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="药店" v-if="record.isOut" required>
                <el-input size="small" placeholder="填写药店名称" style="width: 220px;" v-model="record.drugstoreName"></el-input>
            </el-form-item>
            <el-form-item label="开发人">
                <el-input size="small" placeholder="填写开发人" style="width: 220px;" v-model="record.developPerson"></el-input>
            </el-form-item>
            <el-form-item label="预计开发时间" required>
                <el-date-picker
                        size="small"
                        v-model="record.expectTime">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="是否开发完成" required>
                <el-switch
                        v-model="record.isDevelopComplete"
                        active-text="完成"
                        inactive-text="未完成">
                </el-switch>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button size="small" @click="close">取消</el-button>
            <el-button size="small" type="primary" @click="submit" :disabled="disabled">确定</el-button>
        </div>
    </el-dialog>
</template>

<script>
export default {
  name: 'CreateRecordDialog',
  props: ['exploitRecord', 'visible', 'medicines', 'departments'],
  data () {
    return {
      record: {},
      disabled: false,
      provinces: [],
      cities: [],
      regions: [],
      hospitals: []
    }
  },
  watch: {
    exploitRecord: function (val) {
      if (val.recordId) {
        for (let key in val) {
          this.$set(this.record, key, val[key])
        }
        if (this.record.provinceAreaCode) {
          this.loadNaticePlace({type: 'city', parentCode: this.record.provinceAreaCode})
        }
        if (this.record.cityAreaCode) {
          this.loadNaticePlace({type: 'region', parentCode: this.record.cityAreaCode})
        }
        this.loadHospitals()
      } else {
        this.record = {
          isOut: false,
          isDevelopComplete: false
        }
        this.record.provinceAreaCode = 33
        this.loadNaticePlace({type: 'city', parentCode: this.record.provinceAreaCode})
      }
    }
  },
  mounted () {
    this.loadNaticePlace({type: 'province', parentCode: undefined})
  },
  methods: {
    loadNaticePlace (item) {
      let url = '/region/child/places'
      let data = {
        parentCode: item.parentCode
      }
      this.$http.get(url, data, (res) => {
        switch (item.type) {
          case 'province':
            this.provinces = res.data
            break
          case 'city':
            this.cities = res.data
            break
          case 'region':
            this.regions = res.data
            break
        }
      })
    },
    loadCities (val) {
      if (!val) {
        this.cities = []
        this.regions = []
        this.record.cityAreaCode = undefined
        this.record.regionAreaCode = undefined
      } else {
        this.loadNaticePlace({type: 'city', parentCode: val})
      }
    },
    loadRegions (val) {
      if (!val) {
        this.regions = []
        this.record.regionAreaCode = undefined
      } else {
        this.loadNaticePlace({type: 'region', parentCode: val})
      }
    },
    medicineChange () {
      if (this.record.regionAreaCode) this.loadHospitals()
    },
    loadHospitals () {
      let url = '/exploit/hospitals'
      let data = {
        provinceAreaCode: this.record.provinceAreaCode,
        cityAreaCode: this.record.cityAreaCode,
        regionAreaCode: this.record.regionAreaCode
      }
      if (!this.record.recordId) {
        if (this.record.medicineId) data.medicineId = this.record.medicineId
      }
      this.$http.get(url, data, res => {
        this.hospitals = res.data
      })
    },
    submit () {
      this.disabled = true
      if (!this.record.medicineId) {
        this.$message.warning('请选择品种')
        this.disabled = false
        return
      }
      if (!this.record.hospitalId) {
        this.$message.warning('请选择医院')
        this.disabled = false
        return
      }
      if (!this.record.departmentId) {
        this.$message.warning('请选择部门')
        this.disabled = false
        return
      }
      if (this.record.isOut) {
        if (!this.record.drugstoreName || this.record.drugstoreName.trim() === '') {
          this.$message.warning('请填写药店')
          this.disabled = false
          return
        }
      }
      if (!this.record.expectTime) {
        this.$message.warning('请选择预计开发时间')
        this.disabled = false
        return
      }
      // if (typeof this.record.expectTime === 'object') {
      //   let time = this.record.expectTime.getTime() + 8 * 60 * 60 * 1000
      //   this.record.expectTime = new Date(time)
      // }
      let department = this.departments.filter(item => item.departmentId === this.record.departmentId)[0]
      let medicine = this.medicines.filter(item => item.medicineId === this.record.medicineId)[0]
      let hospital = this.hospitals.filter(item => item.hospitalId === this.record.hospitalId)[0]
      let provinceName = this.provinces.filter(item => item.areaCode === this.record.provinceAreaCode)[0].areaName
      let cityName = this.cities.filter(item => item.areaCode === this.record.cityAreaCode)[0].areaName
      let regionName = this.regions.filter(item => item.areaCode === this.record.regionAreaCode)[0].areaName
      this.record.departmentName = department.departmentName
      this.record.medicineName = medicine.medicineName
      this.record.hospitalName = hospital.hospitalName
      this.record.regionName = provinceName + '-' + cityName + '-' + regionName
      let url = '/exploit/modify'
      this.$http.postJson(url, this.record, (res) => {
        this.$message.success(res.message)
        this.disabled = false
        this.$emit('closeDialog', true)
      }, () => {
        this.disabled = false
      })
    },
    close () {
      this.$emit('closeDialog', false)
    }
  }
}
</script>

<style lang="stylus">
.create-sales-volume{
  .el-form-item{
    margin-bottom 15px
  }
}
</style>
